# bblayers.cond,local.conf,bbapend

## まず結論（位置づけを一言で）

* **bblayers.conf**
  → *「どのレイヤを世界に存在させるか」を決める外枠*
* **local.conf**
  → *「このビルド環境での前提条件」を決める制御室*
* **.bbappend**
  → *「既存の recipe / image / packagegroup に差し込む差分フック」*

つまり
👉 **bblayers.conf / local.conf は“舞台装置”**
👉 **bbappend は“登場人物に後から被せる衣装”**

---

## 全体図に正確に配置するとこうなる

```
        ┌─────────────────────────────┐
        │        local.conf            │
        │  (このビルドの前提条件)     │
        │  MACHINE / DISTRO / FEATURE │
        └───────────┬─────────────────┘
                    │
        ┌───────────▼─────────────────┐
        │        bblayers.conf         │
        │  (使うレイヤの一覧)         │
        │  meta / meta-wrlinux / ...  │
        └───────────┬─────────────────┘
                    │
     ┌──────────────▼─────────────────────┐
     │               LAYERS                │
     │  meta-* / meta-wrlinux / meta-custom│
     │                                      │
     │  ┌───────────────┐                 │
     │  │   *.bb        │◀─ 基本定義       │
     │  │  (recipe)     │                 │
     │  └───────┬───────┘                 │
     │          │                          │
     │  ┌───────▼────────┐                │
     │  │   *.bbappend   │◀─ 差分注入      │
     │  └───────┬────────┘                │
     │          │                          │
     │  ┌───────▼────────┐                │
     │  │ packagegroup   │◀─ 機能の束      │
     │  └───────┬────────┘                │
     │          │                          │
     │  ┌───────▼────────┐                │
     │  │ image (.bb)    │◀─ 箱           │
     │  └───────┬────────┘                │
     │          │                          │
     └──────────▼─────────────────────────┘
                    │
               ┌────▼────┐
               │ rootfs  │
               └─────────┘
```

---

## それぞれをもう一段だけ噛み砕く

---

## ① bblayers.conf の正体（世界の地図）

**場所**

```
build/conf/bblayers.conf
```

**役割**

> 「このビルドで“存在する”レイヤはどれか」

```bitbake
BBLAYERS = " \
  /path/meta \
  /path/meta-wrlinux \
  /path/meta-custom \
"
```

### 重要な事実

* ここに書かれていないレイヤは **存在しない**
* `.bb` も `.bbappend` も **読み込まれない**
* つまり **bbappend が効かない最大原因はここ**

**図での位置**
👉 *レイヤを world に登録するゲート*

---

## ② local.conf の正体（このビルドのルール）

**場所**

```
build/conf/local.conf
```

**役割**

> 「このビルド環境では、どういう前提で組み立てるか」

```bitbake
MACHINE = "myboard"
DISTRO_FEATURES:append = " systemd"
IMAGE_INSTALL:append = " my-debug-tool"
```

### ここで決めるもの

* MACHINE（どのボードか）
* DISTRO / DISTRO_FEATURES
* 並列数、最適化、デバッグ
* 一時的な IMAGE_INSTALL 追加（※恒久設計では非推奨）

**図での位置**
👉 *feature・machine・image に影響する“司令塔”*

---

## ③ .bbappend の正体（差分注入フック）

**場所**

```
meta-custom/recipes-xxx/foo/foo.bbappend
```

**役割**

> 「既存の recipe / image / packagegroup に後から手を入れる」

### 典型例

#### image に追加

```bitbake
IMAGE_INSTALL:append = " myapp"
```

#### recipe を拡張

```bitbake
RDEPENDS:${PN} += " bash"
```

#### 機能分岐

```bitbake
PACKAGECONFIG:append = "${@bb.utils.contains('DISTRO_FEATURES','systemd',' systemd','',d)}"
```

**超重要**

* `.bbappend` は **対応する `.bb` が存在しないと無視される**
* ファイル名一致が必須

  ```
  foo.bb      ← foo.bbappend
  ```

**図での位置**
👉 *recipe / packagegroup / image の内部に刺さる差分*

---

## 3者の関係を一文でまとめると

> **bblayers.conf が「何が存在するか」を決め、
> local.conf が「どういう前提で使うか」を決め、
> bbappend が「既存の定義をどう上書き・拡張するか」を決める**

---

## 実務での典型トラブルと原因マッピング

| 症状                         | 原因                               |
| -------------------------- | -------------------------------- |
| bbappend が効かない             | bblayers.conf にレイヤ未登録            |
| feature を書いたのに何も入らない       | packagegroup が無い                 |
| IMAGE_INSTALL が増えたのに反映されない | local.conf だけ変更して image 再ビルドしてない |
| 設定がどこから来てるかわからない           | local.conf に場当たり追記               |

---

## 今のフェーズでの核心

今の理解段階で一番大事なのはこれ：

> **「local.conf は実験場、bbappend は恒久設計」**

* 試す → local.conf
* 決まった → bbappend（レイヤに閉じる）
* レイヤが増えた → bblayers.conf

この役割分担が腹落ちすると、
Yocto / WRLinux の構成は**“読める設計図”**になる。
