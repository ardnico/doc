# パラメータ

## まず大原則：設定の“レイヤ”を間違えない

### 設定には3種類ある

1. **ビルド時の設定**（コンパイルオプション、機能ON/OFF）
   → `PACKAGECONFIG`, `EXTRA_OECONF`, `EXTRA_OECMAKE`, `EXTRA_OEMAKE`

2. **起動時の設定**（/etc 以下、sysctl、modules-load、systemd unit）
   → `do_install()` でファイルを配置、`inherit systemd`、`modules-load.d`

3. **運用時の設定**（現地で変わる、製品ごと差し替えたい）
   → overlay, `/etc` の分離、別パッケージ化、あるいは初回起動スクリプト

「この設定はどれ？」を最初に決めるのが最大のコツ。

---

## コツ1：パッケージ固有の設定は “別パッケージ化” すると強い

実務で一番事故らないやり方。

* `foo`（本体）
* `foo-config`（設定だけ）
* `foo-service`（systemd unit だけ）

みたいに分けると、差し替えや環境別が楽。

Yocto的にはこういう発想：

* 本体レシピは upstream に寄せる
* 自社差分（設定）は `bbappend` か config 用レシピに閉じ込める

---

## コツ2：`PACKAGECONFIG` を正攻法で使う（機能のON/OFF）

「openssl 有効にしたい」「dbus いらない」みたいなやつはこれ。

例（イメージ）：

```bitbake
PACKAGECONFIG:append = " ssl"
PACKAGECONFIG[ssl] = "--with-ssl,--without-ssl,openssl"
```

判断基準：

* **ビルド成果物が変わる** → `PACKAGECONFIG`
* **起動時にファイルを置くだけ** → `do_install`

---

## コツ3：設定ファイルは `do_install()` で置き、`conffiles` を意識する

例えば `/etc/foo.conf` を入れたいとき。

```bitbake
SRC_URI += "file://foo.conf"

do_install:append() {
    install -d ${D}${sysconfdir}
    install -m 0644 ${WORKDIR}/foo.conf ${D}${sysconfdir}/foo.conf
}

CONFFILES:${PN} += "${sysconfdir}/foo.conf"
```

**CONFFILES** を入れると、パッケージ更新時に設定が扱いやすくなる（上書き挙動がマシになる）。

---

## コツ4：systemd 周りは `inherit systemd` と変数で制御

起動順・自動起動・unit配置を“Yocto流”にする。

```bitbake
inherit systemd
SYSTEMD_SERVICE:${PN} = "foo.service"
SYSTEMD_AUTO_ENABLE:${PN} = "enable"
```

`do_install()` では unit を置くだけ：

```bitbake
do_install:append() {
    install -d ${D}${systemd_system_unitdir}
    install -m 0644 ${WORKDIR}/foo.service ${D}${systemd_system_unitdir}/foo.service
}
```

ここを手作業で `systemctl enable` し始めたら負け。ビルドに組み込む。

---

## コツ5：カーネルモジュール (.ko) の“パラメータ”は置き場所が決まってる

ドライバにパラメータ（module parameter）があるなら、起動時に渡すのはこの2択が基本。

### A) `/etc/modprobe.d/*.conf`（定番）

```
options mydrv foo=1 bar=xyz
```

Yoctoで入れるなら：

```bitbake
SRC_URI += "file://mydrv.conf"

do_install:append() {
    install -d ${D}${sysconfdir}/modprobe.d
    install -m 0644 ${WORKDIR}/mydrv.conf \
        ${D}${sysconfdir}/modprobe.d/mydrv.conf
}
```

### B) `/etc/modules-load.d/*.conf`（自動ロードしたい）

```
mydrv
```

*自動ロード + パラメータ* を両方やりたいなら、

* modules-load.d でロード
* modprobe.d で options

この組み合わせが一番分かりやすい。

---

## コツ6：sysctl、limits、tmpfiles など “OS設定枠”を使う

よくあるやつと置き場所：

* sysctl → `/etc/sysctl.d/*.conf`
* ulimit → `/etc/security/limits.d/*.conf`
* tmpfiles → `/etc/tmpfiles.d/*.conf`

Yocto的には全部「ファイルを置く」だけ。
手で編集したら次回ビルドで消える。

---

## コツ7：現場で壊れがちなパターンを避けるチェックリスト

### 「設定が効いてない」あるある原因

* そもそもファイルが rootfs に入ってない
  → `find /etc -name '*foo*'`、`rpm -qf` で所有パッケージ確認
* unit は入ってるが enable されてない
  → `SYSTEMD_AUTO_ENABLE`
* feature不足（systemd無効、ipv6無効、opensslなし）
  → `DISTRO_FEATURES` / `PACKAGECONFIG` の見直し
* 依存パッケージ不足（RDEPENDSが抜けてる）
  → `bitbake -e` で確認

---

## 最小化と相性の良い「設定運用」戦略

パッケージ最小化をしたいなら、設定はこう設計すると後で詰まらない：

* **必須設定**は image に直結（packagegroup 経由）
* **機種依存設定**は machine か BSP レイヤへ
* **製品SKU差分**（Aモデル/Bモデル） は `foo-config-a` `foo-config-b` に分離
* **現地変更**がありうるものは overlay / 初回起動スクリプトで吸収

---

## ここまでを踏まえた “一言まとめ”

ボトルネックを壊すコツはこれ：

**「設定を do_install でファイルとして配る」「自動化は systemd/modprobe/modules-load の枠に乗せる」「差分は config パッケージに隔離」**。

これを守ると、Yocto/WRLinux が一気に“再現性のある工場”になる。
