# Packagegroupとdistro feauture machine feautureとかとの関係図

ここを**構造で理解できるかどうか**が、
「Yocto/WRLinux を設計できる人」と「とりあえず動かす人」の分水嶺。

まず **全体像の一枚絵** を出す。そのあとで各要素の役割を噛み砕く。

---

## 全体構造（最重要図）

```
                    ┌────────────────────┐
                    │   DISTRO_FEATURES  │
                    │  (ディストロ方針) │
                    │  systemd, x11 etc │
                    └─────────┬──────────┘
                              │
                              ▼
┌──────────────┐      ┌──────────────────┐
│ MACHINE      │      │ PACKAGEGROUP     │
│ FEATURES     │─────▶│ (機能の束)       │
│ (HW能力)    │      │ packagegroup-xxx │
│ usb, pci etc│      └─────────┬────────┘
└──────┬───────┘                │
       │                        ▼
       │               ┌──────────────────┐
       │               │   IMAGE          │
       │               │ (rootfs定義)     │
       │               │ IMAGE_INSTALL    │
       │               └─────────┬────────┘
       │                         │
       ▼                         ▼
┌─────────────────────────────────────────┐
│              ROOTFS                     │
│  実際に入るバイナリ・lib・service       │
└─────────────────────────────────────────┘
```

**一言でまとめると：**

* **feature系（distro / machine）**
  → *「何が可能か」「何を許可するか」*
* **packagegroup**
  → *「じゃあ何を入れる？」*
* **image**
  → *「最終的に全部まとめて詰める箱」*

---

## 各要素の役割（混乱ポイントを潰す）

---

## ① DISTRO_FEATURES（思想・方針）

```
DISTRO_FEATURES = "systemd ipv6 x11 ..."
```

### 何者？

* **ディストリビューション全体の思想**
* 「この Linux は何をサポートするのか」を宣言する

### 特徴

* *抽象度が高い*
* 直接パッケージを入れるわけではない
* **PACKAGECONFIG / 条件分岐のスイッチ**になる

### 例

```bitbake
DISTRO_FEATURES:append = " systemd"
```

→ 各レシピが
「systemd feature が有効なら systemd 用設定を入れる」
みたいに分岐する

---

## ② MACHINE_FEATURES（ハードの現実）

```
MACHINE_FEATURES = "usb pci i2c spi"
```

### 何者？

* **そのボードが物理的に持っている能力**
* SoC / Board 固有

### 特徴

* *嘘をつくと死ぬ*
* ドライバや packagegroup の条件に使われる

### 例

```bitbake
MACHINE_FEATURES += "i2c spi"
```

→

* i2c ドライバ
* spi ツール
  が「条件付きで入る」ようになる

---

## ③ PACKAGEGROUP（実体の束）

```
packagegroup-core-boot
packagegroup-wrlinux-base
packagegroup-custom-drivers
```

### 何者？

* **パッケージの集合体**
* feature を「具体的なファイル」に変換する存在

### 中身はただの RDEPENDS

```bitbake
RDEPENDS:${PN} = "
    busybox
    systemd
    kernel-modules
"
```

### 超重要な役割

* feature → 実体 をつなぐ **翻訳機**

---

## ④ IMAGE（最終組み立て）

```
IMAGE_INSTALL += "packagegroup-wrlinux-base"
```

### 何者？

* rootfs を作る **最終レイヤ**
* packagegroup も個別パッケージも全部ここに集約

---

## 実務での「正しい流れ」

### ❌ ダメな考え方（場当たり）

```
IMAGE_INSTALL += "foo bar baz qux"
```

→

* 何が必須で
* なぜ入っていて
* どこで制御されているか不明

---

### ✅ 正しい設計思考

```
[DISTRO_FEATURES]  ── 方針
[MACHINE_FEATURES] ── ハード条件
        │
        ▼
[PACKAGEGROUP]     ── 機能単位
        │
        ▼
[IMAGE]            ── 組み立て
```

---

## 具体例（I2C ドライバを入れたい場合）

### ① MACHINE_FEATURES

```bitbake
MACHINE_FEATURES += "i2c"
```

### ② packagegroup

```bitbake
RDEPENDS:${PN} = "\
    kernel-module-i2c-dev \
    i2c-tools \
"
```

### ③ IMAGE

```bitbake
IMAGE_INSTALL += "packagegroup-custom-i2c"
```

→
「このボードは i2c を持つ」
「i2c を使うならこれ一式を入れる」
「それを image に載せる」

**責務分離が完璧**

---

## 重要な誤解を正す（ここ試験に出る）

### Q. feature を書けば自動で入る？

❌ NO

feature は **条件** であって **中身ではない**

---

### Q. packagegroup は必須？

✅ YES（規模が少しでも大きくなるなら）

個別パッケージ直書きは
**最初だけ楽で、後で破綻する**

---

### Q. distro と machine feature の違いは？

| 項目   | distro  | machine |
| ---- | ------- | ------- |
| 意味   | 方針      | 物理      |
| 変更頻度 | 低       | 低       |
| 嘘    | まあOK    | 死ぬ      |
| 例    | systemd | i2c     |

---

## 今のボトルネック（推定）

> 「どこに何を書くべきか」が霧っている

それを壊す鍵はこの一文：

> **feature は判断材料、packagegroup が実体、image は箱**

---
