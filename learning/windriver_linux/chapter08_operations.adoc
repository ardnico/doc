== 第8章: 運用とライフサイクル管理
本章ではWRL導入後の運用フェーズに焦点を当て、リリース管理、監視、フィールドサポート、廃止計画までのライフサイクルを整理します。

=== リリース管理
* *バージョニング*: セマンティックバージョニング(SemVer)をベースに、WRLリリース番号と社内ビルド番号を組み合わせた命名規則を採用。
* *リリース分岐*: Gitで`main`(開発)と`maintenance/x.y`(保守)ブランチを管理し、CVE修正を選択的にバックポート。
* *ドキュメント*: リリースノートに新機能、既知の制限、テスト結果、SBOMのパスを明記。

=== モニタリングとアラート
* *メトリクス収集*: `collectd`, `telegraf`などのエージェントをWRLイメージに組み込み、CPU/メモリ/ディスク/ネットワークを監視。
* *ログ分析*: ELKスタックやSplunkへ`rsyslog`でログ転送し、アラートルールを設定。
* *ヘルスチェック*: systemdの`WatchdogSec`やアプリケーションのRESTヘルスエンドポイントで稼働状況を監視。

[source,systemd]
----
# my-service.service
[Service]
ExecStart=/usr/bin/my-service
Restart=on-failure
WatchdogSec=30s
----

=== アップデート運用
* *段階的展開*: カナリアリリースやロールアウト比率を定め、小規模なフィールド装置で検証後に全面展開。
* *ロールバック*: A/Bパーティションやスナップショットを活用し、アップデート失敗時に自動復旧する仕組みを構築。
* *メンテナンスウィンドウ*: 顧客と合意した時間帯にアップデートを行い、停止影響を最小化。

=== サポートプロセス
Wind Riverのサポート契約を最大限活用するため、以下を整備します。

[%autowidth,options="header"]
|===
|ステップ|内容|成果物
|チケット起票|Customer Portalでケース登録|再現手順、ログ、イメージバージョン
|一次解析|社内L3チームがログ解析、パッチ適用|暫定回避策、影響分析
|Wind River連携|必要に応じてWind Riverへエスカレーション|追加パッチ、根本原因報告
|クローズ|対処確認、ドキュメント更新|ナレッジベース記事、教訓
|===

=== ライフサイクル終了(End-of-Life)計画
* *サポート期限*: Wind River LTSサイクル(通常5年)に合わせ、製品サポート終了計画を策定。
* *データ移行*: アプリケーションデータやユーザ設定を安全にエクスポートし、新バージョンへ移行する手順を定義。
* *廃棄*: セキュアイレースや物理破壊など、装置廃棄時の情報漏洩対策を明記。

=== コストとリソースの最適化
* *ビルドインフラ*: JenkinsやGitLab CIでビルドを自動化し、クラウドビルドリソースをスポット利用してコスト削減。
* *サプライチェーン*: 部品のライフサイクルに合わせてBSPを更新し、EOL部品が影響する前に代替策を検討。
* *トレーニング*: Wind River提供のオンライントレーニングや社内ハンズオンを計画的に実施し、ノウハウを属人化させない。

=== チェックリスト
* [ ] リリース管理方針とバージョン命名規則が文書化されている。
* [ ] 監視メトリクスとアラート条件がSLAに基づき設定されている。
* [ ] アップデートとロールバック手順が自動化され、テスト済みである。
* [ ] Wind Riverサポートへのエスカレーション手順が明文化されている。
* [ ] ライフサイクル終了時のデータ移行・廃棄手順が確立されている。

=== さらに磨きをかける運用プラクティス

==== SLOとエラーバジェット管理
運用品質を定量管理するため、サービスレベル目標(SLO)とエラーバジェットを設定します。WRL搭載装置の稼働率や復旧時間をPrometheusなどで計測し、SLO違反が近づいた場合はリリースフリーズや追加テストの実施判断を行います。Wind River Studioなどのクラウド管理基盤を利用する場合、SLOメトリクスをダッシュボードに集約し、意思決定の指標とします。

==== フリートマネジメント
数百〜数千台規模で装置を運用する際は、デバイス管理サービスと連携してバッチ操作や状態監視を自動化します。

* `Mender`, `Hawkbit`, `SWUpdate`などのOTAサーバを採用し、WRLイメージの署名と配布を一元管理。
* デバイス側に`python3-wrs-fleet-agent`(社内実装)などのエージェントを配布し、指示に応じて`systemctl`操作やログ収集を実行。
* フリートID、ロケーション、通信キャリア情報を資産管理台帳に登録し、障害発生時のフィールドエンジニア派遣を迅速化。

==== 運用自動化スクリプト
運用作業の属人化を防ぐため、AnsibleやSaltStackで標準化されたPlaybookを整備します。

[source,yaml]
----
- hosts: wrl_edge
  gather_facts: no
  tasks:
    - name: Collect system report
      command: /usr/bin/wrl-support-collect
      register: report
    - name: Upload report to S3
      aws_s3:
        bucket: wrl-support-artifacts
        object: "{{ inventory_hostname }}/{{ ansible_date_time.iso8601 }}.tar.gz"
        src: "{{ report.stdout }}"
----

Playbookと合わせてアクセスキーの管理、監査ログの取得方法を記載したRunbookを保守部門と共有します。

==== フィードバックの継続的改善
フィールドから得た知見を開発へ確実に還元するため、Postmortem会議や定期レトロスペクティブを実施します。指摘事項は`blameless`な文化で扱い、`action item`の進捗をJiraやBacklogでトラッキングします。Wind Riverサポートからのフィードバックも同じトラッキングボードに登録すると、改善活動が一元化されます。

==== コスト最適化の高度化
クラウドリソースを利用するビルド/テスト環境では、使用状況を可視化しスポットインスタンスや自動シャットダウンを活用します。`terraform`でインフラをコード化し、`cost-anomaly-detection`などのサービスで予算超過を早期検知します。オンプレミス環境では、ビルドサーバの仮想化基盤(VMware, OpenStack)を活用し、夜間に自動スケールダウンする仕組みを構築します。
