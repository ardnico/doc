== 第6章: セキュリティとメンテナンス
産業用途でWRLを運用する際、セキュリティ対策と継続的なメンテナンスは不可欠です。本章では脆弱性管理、SBOM生成、ランタイム防御、アップデート戦略を整理します。

=== セキュリティポリシーの整備
* *脅威モデル*: 攻撃ベクトル(物理アクセス、リモート侵入、サプライチェーン)を特定し、優先順位を付ける。
* *アクセス制御*: `DISTRO_FEATURES`で`pam`, `audit`を有効化し、`meta-selinux`レイヤで強制アクセス制御を導入。
* *ログ監査*: `auditd`を有効化し、セキュリティイベントを中央サーバへ送信。

[source,bitbake]
----
DISTRO_FEATURES:append = " pam audit"
IMAGE_INSTALL:append = " auditd"
----

=== 脆弱性管理
Wind RiverはCVEパッチを提供するセキュリティ通知を配信します。対応フローの例を示します。

1. セキュリティチームが`WRL Security Advisory`を受信し、影響範囲を評価。
2. `bitbake-layers show-overlayed`で該当レシピが社内レイヤで上書きされていないか確認。
3. `git cherry-pick`でWind Riverが提供する修正を適用し、`bitbake <recipe> -c do_patch -f`で再適用。
4. 自動テストと脆弱性スキャナ(OpenSCAPなど)で検証し、本番適用の判断を行う。

[IMPORTANT]
====
CVE対応はイメージ全体の再ビルドとテストが前提です。個別パッケージの差し替えのみで本番適用すると依存関係の整合性が崩れる恐れがあります。
====

=== SBOM(ソフトウェア部品表)生成
WRL 23以降では`wrl-sbom`ツールが提供され、SPDX形式のSBOMを生成できます。

[source,bash]
----
bitbake wrlinux-image-glibc-std -c wrl-sbom
ls tmp/deploy/sbom/
# wrlinux-image-glibc-std-intel-x86-64.spdx.json
----

SBOMは以下の用途に活用します。

* セキュリティスキャナとの連携。
* 顧客向けに提供する法的文書(License disclosure)の作成。
* 規格準拠(ISO/SAE 21434など)で要求されるソフトウェア構成証跡。

=== ランタイム防御
* *Secure Boot*: UEFI Secure BootやU-Bootの`FIT`イメージ署名を有効化し、署名鍵の保護手順を定義。
* *TLS資産管理*: `oscrypto`, `openssl`の証明書更新を自動化し、CRL/OCSPの監視を行う。
* *ファイル整合性*: `ima`/`evm`を活用し、重要ファイルの改ざん検知を設定。

[source,bitbake]
----
DISTRO_FEATURES:append = " ima"
IMAGE_INSTALL:append = " ima-evm-tools"
----

=== アップデート戦略
WRLは複数のアップデートメカニズムをサポートします。

[%autowidth,options="header"]
|===
|方式|概要|適用シナリオ|注意点
|パッケージ更新(`rpm`)|個別パッケージを差分更新|開発段階、軽微な修正|依存解決とリブート要否を明確に
|A/Bアップデート(`swupdate`, `mender`)|2つのパーティションを切り替え|フィールドでのロールバック重視|ストレージ容量確保、署名検証
|コンテナ更新|アプリケーションをコンテナで提供|クラウド連携型エッジ装置|ホストOSとカーネルの互換性を維持
|===

[NOTE]
====
Wind Riverは`OSTree`ベースの更新機構も提供しており、大規模デプロイに適した差分配信を実現します。社内のデプロイメント基盤と整合性を確認してください。
====

=== 運用監視
* *ログ転送*: `rsyslog`/`journald`でセキュリティイベントをSIEMへ送信。
* *脆弱性スキャン*: OpenSCAP、ClamAVなどを定期実行。
* *キー管理*: TPMやHSMを活用し、署名鍵を安全に保管。

=== チェックリスト
* [ ] セキュリティポリシーと脅威モデルが文書化されている。
* [ ] CVE対応フローと役割分担が明確になっている。
* [ ] SBOM生成手順と成果物の保管場所が定義されている。
* [ ] Secure Bootやファイル整合性チェックの設定がテストされている。
* [ ] アップデート方式ごとのリスク評価が完了している。
